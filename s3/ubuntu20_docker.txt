docker run -it --rm \
  --env="DISPLAY" \
  --env="QT_X11_NO_MITSHM=1" \
  --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
  ubuntu:20.04 /bin/bash


# Run -it: Interactive, Terminal 
# --rm: remove container when finished
# Display: passes system's display environment variable onto container - tells graphical programs where to render
# Env QT ... : Fix for some QT, openGL apps that dont like docker's shared memory - Prevents crash when running pangolin
# Volume ... : mounts host x11 socket into the container, GUI windows can show up on host screen



# DOCKER FILE: has dso and pangolin dependencies
# Exists as a docker IMAGE 
# Not the same as a container, which can be removed each time I exit


# TO INCLUDE DATASET FOLDER

docker run -it --rm \
    -v /home/daniel-choate/Datasets/MonoVO:/datasets \
    dso:20.04 bash

# WITH GPU ACCESS

docker run -it --rm \
    --gpus all \
    -e DISPLAY=$DISPLAY \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v /home/daniel-choate/Datasets/MonoVO:/datasets \
    dso:20.04 bash


docker run -it --rm \
    --gpus all \
    -e DISPLAY=$DISPLAY \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v /home/daniel-choate/Datasets/VTTI_airfield/MSNV_0000_0000_0_250804_1830_00156/DSO_Test:/datasets \
    dso:20.04 bash



#************ DOCKER FILE NOTES
Base system - starts from Ubuntu 20.04
- Disable active prompts: speed up docker build

Install dependencies: CMake, Git, OpenCV, Eigen, Boost
- Suitesparse, Atlas, OpenGL libs
- Cleans up apt cache to keep the image smaller (removes files after apt-get install) - saves storage in final docker image

Install Pangolin: repo at v0.5
- builds with video, ffmpeg python, example support DISABLE (avoiding extra dependencies)

Clone DSO: Jakob Engel
- Initialize any submodules

Build ziplib - DSO dependency 

Patch DSO for opencv4
- replaces old CV_LOAD_IMAGE_* flags with new flags to make it compile with modern opencv

Build DSO 
- creates a build directory
- compiles DSO with pthread flags - for complier and linker

Default environment
- working directory set to /opt/dso
- container opens into a bash shell by default


******************* 
RUNNING DSO 

Change sequence 49 to specific file

bin/dso_dataset \
    files=/datasets/sequence_49/images.zip \
    calib=/datasets/sequence_49/camera.txt \
    gamma=/datasets/sequence_49/pcalib.txt \
    vignette=/datasets/sequence_49/vignette.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/Images_PP \
    calib=/datasets/camera.txt \
    gamma=/datasets/pcalib.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0

bin/dso_dataset \
    files=/datasets/Images_PP_NEW \
    calib=/datasets/camera_NEW.txt \
    gamma=/datasets/pcalib.txt \
    vignette=/datasets/vignetteT.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps/Images_PP \
    calib=/datasets/camera_test.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps_unchanged/Images_gray \
    calib=/datasets/camera_radtan.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps_unchanged/Images_TSR_Gray \
    calib=/datasets/camera_radtan.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette_constant.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps_nondist/Images_TSR_Gray \
    calib=/datasets/camera_radtan.txt \
    gamma=/datasets/pcalib_mvo.txt \
    preset=0 mode=0


# NOTE: SHUFFLING FILES AROUND FOR BETTER ORGANIZATION 
# 'undist' means undistorted
# 'unchanged' means the original images (but grayscale)
# Here, I am using my own undistorted images
# With the pinhole model

bin/dso_dataset \
    files=/datasets/60_fps_undist/Images_TSR_Gray_UND \
    calib=/datasets/camera_NEW.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette_constant.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps_undist/Images_PP \
    calib=/datasets/camera_test.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0


bin/dso_dataset \
    files=/datasets/60_fps_undist/Images_TSR_Gray_UND \
    calib=/datasets/camera_test_half.txt \
    gamma=/datasets/pcalib_mvo.txt \
    vignette=/datasets/vignette_constant.png \
    preset=0 mode=0

bin/dso_dataset \
    files=/datasets/60_fps_undist/Images_TSR_Gray_UND \
    calib=/datasets/camera_NEW.txt \
    gamma=/datasets/pcalib_0.85.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0

bin/dso_dataset \
    files=/datasets/60_fps_undist/Images_TSR_Gray_UND \
    calib=/datasets/camera_test_half.txt \
    gamma=/datasets/pcalib_0.85.txt \
    vignette=/datasets/vignette.png \
    preset=0 mode=0
